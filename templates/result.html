{% extends 'base.html' %}

{% block content %}
  <h1>{% block title %}Stylized Image{% endblock %}</h1>
  <div id="processing" hidden>
    <h2>Processing</h2>
    <p>Please wait.</p>
    <p id="processing-queue-position">&nbsp;</p>
    <div class="spinner"></div>
    <form action="{{ url_for('cancel', session_id=request.view_args['session_id'],
      job_id=request.view_args['job_id']) }}" method="post">
      {{ cancel_form.csrf_token }}
      <input type="submit" value="Cancel">
    </form>
  </div>
  <div id="result" hidden>
    <h2>Finished</h2>
    <img id="result-image" src="" height="480" alt="">
    <p><a href="{{ url_for('image', session_id=request.view_args['session_id'], job_id=request.view_args['job_id'],
      filename=filename, download=1) }}">Download</a></p>
    <p>Your image will be available for <strong>{{ settings.RESULT_TTL_MINUTES }} minutes</strong>.</p>
  </div>
  <div id="job-error" hidden>
    <h2>Error</h2>
    <p>There was a problem processing your image.</p>
  </div>
  <div id="ajax-error" hidden>
    <h2>Error</h2>
    <p>Unable to retrieve the status of your image.</p>
    <p>Reason: <span id="ajax-error-reason"></span></p>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.5/axios.min.js"></script>
  <script>
      const processingElement = document.getElementById('processing');
      const processingQueuePositionElement = document.getElementById('processing-queue-position');
      const resultElement = document.getElementById('result');
      const resultImageElement = document.getElementById('result-image');
      const jobErrorElement = document.getElementById('job-error');
      const ajaxErrorElement = document.getElementById('ajax-error');
      const ajaxErrorReasonElement = document.getElementById('ajax-error-reason');

      function setState(status, position) {
          if (status === 'finished') {
              processingElement.hidden = true;
              resultElement.hidden = false;
              resultImageElement.src = '{{ url_for('image', session_id=request.view_args['session_id'],
                job_id=request.view_args['job_id'], filename=filename) }}';
          } else if (status === 'failed' || status === 'stopped' || status === 'canceled') {
              processingElement.hidden = true;
              jobErrorElement.hidden = false;
          } else {
              processingElement.hidden = false;
              if (position != null) {
                  processingQueuePositionElement.innerHTML = 'Position in queue: ' + (position + 1);
              } else {
                  processingQueuePositionElement.innerHTML = '&nbsp;';
              }
              setTimeout(poll, {{ settings.AJAX_POLL_INTERVAL }} * 1000);
          }
      }

      function poll() {
          axios.get('{{ url_for('status', session_id=request.view_args['session_id'],
            job_id=request.view_args['job_id']) }}', {timeout: {{ settings.AJAX_TIMEOUT }} * 1000})
              .then(function (response) {
                  setState(response.data.status, response.data.position);
              })
              .catch(function (error) {
                  processingElement.hidden = true;
                  ajaxErrorElement.hidden = false;
                  ajaxErrorReasonElement.innerHTML = error.message;
                  console.error(error);
              });
      }

      setState('{{ status }}', {{ position if position is not none else 'null' }});
  </script>
{% endblock %}
